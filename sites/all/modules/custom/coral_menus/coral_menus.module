<?php
/**
 * Coral Menus is fresh off the press so it's going to be buggy! But at the moment
 *  it will keep your menus, as defined in the coral_menu includes folder, synced
 *  with actual system menus. 
 */
// Get the menus defined by this module 
//  @TODO make this hookable - reach into other modules to get definitions!
coral_include('includes', 'inc', 'coral_menus');

// Prefix that will be appended to Coral menu's menus - see menu admin page.
define('CORAL_MENUS_PREFIX', 'Coral menus: ');


/**
 * Implementation of hook_init()
 */
function coral_menus_init() {
  coral_menus_run_updates();  
}


/**
 * Core menu initialization! zaap!
 */
// ----------------------------------------------------------------------
// Check the status of the menu definitions as they exist in the
//  repo vs how they exist in the db. Update all relevant db items
//  to reflect the definition.
function coral_menus_run_updates() {
  
  // load the menu state from db (contains links mlid's)
  $orig_state = $current_state = variable_get('coral_menus_menu_state', array());

  $path = drupal_get_path('module', 'coral_menus');  // This module path 
  $menus = coral_menus_read_dir($path.'/includes');  // Read menu structure
  
  // Are these menus in the db?
  foreach ($menus as $i => $menu) {
    $mname = str_replace('.inc', '', $menus[$i]);    // menu name
    $mfunc = 'coral_menus_'.$mname.'_menu_loader';   // menu func
    $lfunc = 'coral_menus_'.$mname.'_links_loader';  // menu links func
    
    // Development regeneration - enable above
    coral_menu_reset($mname, $mfunc, $current_state); // Reset if necc.
    
    // Check on the state status - if empty, regenerate!
    if (!empty($current_state[$mname])) {
      $in_state = $current_state[$mname]; // load from state variable
    }
    else { // state not found... reset menus and reset state
      coral_menu_reset($mname, $mfunc, $current_state, TRUE); // Reset if necc.
    }

    // menu as it is from the db
    $in_db = menu_load($mname);

    // --- Initialize and create new menu + links
    if (!$in_db) { // not in db yet - time to import from the files!

      // Check if the menu function is callable
      if (function_exists($mfunc)) { $m = $mfunc(); // Load definition

        // If we have a defined menu, proceed
        if (!empty($m)) { coral_menus_menu_save($m, $current_state); // Save new menu

          // Do we have any links to add?
          if (function_exists($lfunc)) { $l = $lfunc(); // Load links

            // Save each link - it's a miracle!
            foreach ($l as $link_name => $link) {

              // will write the mlid back to the file if it does not already exist there
              coral_menus_link_save($m, $link_name, $link, $current_state);
            }
          }
        } 
      }
    }

    // menu already in the db - updates
    else {

      // Check if the menu function is callable
      if (function_exists($mfunc)) { $m = $mfunc(); // call this menu definition.
        
        // the menu is defined in code
        if (!empty($m)) {

          // If we have a defined menu, proceed
          if (coral_menus_menus_eq($m)) { // Menus are equal; check links
          
            // Check links
            coral_menus_manage_links($lfunc, $m, $current_state);
          }
          else { // Menus differ
          
            // Update the menu in the state according to the definition
            coral_menus_menu_save($m, $current_state);
            
            // Check links
            coral_menus_manage_links($lfunc, $m, $current_state);
          }
        }
      }
    }
  }

  //Did the states change on this process?
  $orig_state_sha      = sha1(serialize($orig_state));
  $current_state_sha   = sha1(serialize($current_state));
  if ($orig_state_sha != $current_state_sha) {
    variable_set('coral_menus_menu_state', $current_state);  
  }
  //dpm($current_state);
}


/** -------------------------------------------------------------------
 * Helper functions
 */


// --- Manages updating already created link sets
//  Needs to loop through all the links in this menu
//  and check if the state needs updating (db & state change)
function coral_menus_manage_links($lfunc, $menu, &$state) {
    
  $links = $lfunc();
  $updated = 0;
  $orig_state = $state;
  
  // Cycle through the links and update the necc. fields
  foreach ($links as $name => $link) { //dpm($link);
    // Holds this link's changes
    $changes = array();

    // Do we need to update the link in the state and db?
    if (!coral_menus_link_eq($name, $link, $menu, $state, $changes)) {
     
      // Loop through the changeset returned by the equality measurer
      foreach ($changes as $linkid => $changeset) {

        // Number of links updated
        $updated++;

        // Update the state and db with new values from file.
        foreach($changeset as $key => $change) {

					// Apply this change to the state variable
          $state[$menu['menu_name']]['links'][$linkid][$key] = $change;
        }

        // Update the link in the db
				coral_menus_link_save($menu, $linkid, $state[$menu['menu_name']]['links'][$linkid], $state);
      }
    }
    else { } // Link equals definition... nothing to do here.
  }
  if ($updated) {
  	// Woof!
    watchdog('Coral Menus', 'Updated '.format_plural($updated, '1 link', '@count links'), NULL, WATCHDOG_NOTICE);
  }
}


// --- Save a menu now! Tomorrow could be too late
function coral_menus_menu_save($menu, &$state) {

  // Save to the db
  menu_save($menu);

  // add this menu's distinctiveness to it's own
  $state[$menu['menu_name']]['menu'] = $menu;
  
	// Lets keep a record, eh?
  watchdog('Coral Menus', 'Updated menu '.$menu['menu_name'], NULL, WATCHDOG_NOTICE);
} 


// --- Saves one menu link
function coral_menus_link_save($menu, $name, $link, &$state) {

	// Ensure the proper menu get's the link - this will override your settings
	//  If its in the "main" menu links definitions, it IS going in the main menu!
	//  Don't like it? Move that link definition to the right file. 
	$link['menu_name'] = $menu['menu_name'];

  // Is the module defined - set to 'menu' so we can get the menu ops! e.g. (delete)
  $link['module'] = (!empty($link['module'])) ? $link['module'] : 'menu';
  
  // Do we need to translate any plid's?
  coral_menus_translate_link_parent($link, $menu, $state);
  
  // Save the link to the db
  menu_link_save($link);
  
  // Save the link to state
  $state[$menu['menu_name']]['links'][$name] = $link;
}


// --- Translate a menu link's id plid to a real plid
function coral_menus_translate_link_parent(&$link, $menu, &$state) {

  // A parent exists and translation is needed
  if (!empty($link['plid']) && !is_numeric($link['plid'])) {

    // Cycle through the items in this menu's state
    foreach ($state[$menu['menu_name']]['links'] as $name => $parent_candidate) {

      // Found a match for the plid that translates?  
      if ($name == $link['plid']) {
        
        // Save the parent's plid to the plid.
        $link['plid'] = $parent_candidate['mlid'];
        return $link['plid']; // return it...       
      }
    }
  }
  else { } // No parents
  
  return FALSE;
}

 
// --- Check if a menu definition is eq to the instance in the db
function coral_menus_menus_eq($m) {
  $mdb = menu_load($m['menu_name']); // load this menu from db too  
  $compm = sha1(serialize($m));      // get the sha1 hash of this menu definition
  $compmdb = sha1(serialize($mdb));  // get the sha1 hash of this menu row
  if ($compm === $compmdb) return TRUE; return FALSE;
}


/**
 * @TODO: We need a way to detect when link values are removed...
 */
// --- Link equality: current state vs the state in db
function coral_menus_link_eq($link_name, $link_def, $menu, $state, &$changes) {
  
  $eq = TRUE; // Help determine if we need to regenerate this link
  $check_keys = array_keys($link_def); // The keys that we have defined in the file definition

  // Go through the defined keys
  foreach($check_keys as $key) {
    
    if ($key == 'plid' && !is_numeric($link_def[$key])) {
      $link_def[$key] = coral_menus_translate_link_parent($link_def, $menu, $state);
    }

    $def_hash   = sha1(serialize($link_def[$key])); // defined has values
    $state_hash = ''; // Empty container for the state hash
    if (!empty($state[$menu['menu_name']]['links'][$link_name][$key])) {
      $state_hash = sha1(serialize($state[$menu['menu_name']]['links'][$link_name][$key])); // state hash value
    }

    if ($def_hash != $state_hash) {
      // Data different  
      $changes[$link_name][$key] = $link_def[$key];  
      $eq = FALSE; // Who moved my cheese?!
    }
    else { } // Data same
  }
  
  // boolean
  return $eq;
}


// --- Read in the files and directory structure
function coral_menus_read_dir($dir) {
  $result = array(); 
  $cdir = scandir($dir); 
  foreach ($cdir as $key => $value) {
    if (!in_array($value,array(".",".."))) {
      if (is_dir($dir . DIRECTORY_SEPARATOR . $value)) 
        $result[$value] = coral_menus_read_dir($dir . DIRECTORY_SEPARATOR . $value); 
      else $result[]  = $value; 
  }} return $result;
}


// --- Optionaly clear all menus and regenerate from scratch
function coral_menu_reset($menu, $mfunc, &$current_state, $reset = FALSE) {
  if (variable_get('coral_menus_reset', FALSE) || $reset) {
    
    // call the menu definition    
    $m_def = $mfunc();
    
    // Only delete if it has definition
    if ($m_def) menu_delete($m_def);
    
		// Lets keep a record, eh?
  	watchdog('Coral Menus', 'Regenerating all menus! Set the "CORAL_MENUS_RESET" definition in coral_menus.module to FALSE to disable regeneration.', NULL, WATCHDOG_WARNING);
  }
}


